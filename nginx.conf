user root;
daemon off;
# 绑定cpu亲核性，减少cache未命中，请根据实际情况修改
# worker_processes 1;
# worker_cpu_affinity 1;
worker_processes auto;
worker_cpu_affinity auto;
# 日志输出到标准输出
error_log /dev/stdout;
events {
    # 设置单个worker连接数
    worker_connections 10240;
    # 高性能事件驱动
    use epoll;
}

http {
    # 增加哈希桶大小，解决server_name哈希表构建失败问题
    server_names_hash_bucket_size 64;  # 添加这一行
    # 配置名为access的log输出格式
    log_format access '$remote_addr $server_port - $http_host [$time_local] '
                      '"$request" $status $body_bytes_sent '
                      '"$http_referer" "$http_user_agent" '
                      '$http_x_forwarded_for|$http_x_real_ip|$limit_key';
    # log日志输出到标准输出
    # access_log /dev/stdout access;
    # 关闭日志，提高性能。开启日志，排查问题
    access_log off;

    # ==================== 高级流控配置 ====================
    
    # 白名单不限速
    geo $limit {
        default 1;
        192.168.0.0/24 0;
        10.0.0.0/8 0;
        127.0.0.0/8 0;
    }

    # Header有X-Forwarded-IP就用xff，没有就用数据包的源IP
    map $http_x_forwarded_for $real_ip {
        default         $remote_addr;
        "~^(?P<ip>[^,]+)" $ip;
    }

    # 匹配到白名单就为空不限速，没匹配到就限速
    map $limit $limit_key {
        0 "";
        1 $real_ip;
    }

    # ==================== User-Agent 控制 ====================
    # 恶意User-Agent检测和阻止
    map $http_user_agent $bad_ua {
        default 0;
        "~*(python|curl|wget|nikto|sqlmap|nmap|nessus|metasploit|hydra|john)" 1;
        "~*(scan|bot|crawl|spider|scanner|exploit|attack|malware|virus)" 1;
        "~*(zgrab|masscan|gobuster|dirb|ffuf|amass|subfinder)" 1;
        "" 1;  # 空User-Agent
    }

    # ==================== CDN 识别配置 ====================
    # 从外部文件加载CDN IP段
    include /app/cdn_ips.conf;

    # CDN白名单 - 基于真实IP的CDN识别
    map "$is_cloudflare$is_edgeone" $real_cdn_ip {
        default 0;
        "~*1" 1;  # 如果任意一个CDN为1，则标记为真实CDN流量
    }

    # 检测伪造的CDN请求头
    map "$http_cf_connecting_ip$http_x_forwarded_for$http_x_real_ip" $fake_cdn_header {
        default 0;
        "~*[^0]" 1;  # 如果存在任何CDN头，则标记为需要验证
    }

    # 最终CDN白名单（真实CDN IP且无伪造头）
    map "$real_cdn_ip$fake_cdn_header" $cdn_whitelist {
        default 0;
        "10" 1;  # 真实CDN IP且无伪造头
        "1." 0;  # 伪造CDN头
    }

    # ==================== 请求头过滤 ====================
    # 检测恶意请求头
    map $http_user_agent $bad_header {
        default 0;
        "~*(\.\./|\.\.\\|%00|%0a|%0d)" 1;  # 路径遍历和特殊字符
    }

    # ==================== SNI 路由控制 ====================
    # 基于SNI的域名路由
    map $ssl_server_name $sni_domain {
        default "unknown";
        "~*.dk8s.com" "dk8s_domain";
        "~*.520613.xyz" "hwy_domain";
    }

    # ==================== 时间窗口控制 ====================
    # 纳秒级时间戳控制
    map $msec $time_window {
        default "normal";
        "~*^(\d+)\.(\d+)$" $1;  # 提取秒级时间戳
    }

    # 请求时间控制 - 检测异常快速请求
    map $request_time $fast_request {
        default 0;
        "~*^0\.00[0-2]" 1;  # 小于2ms的请求视为异常
    }

    # ==================== 限流配置 ====================
    geo $whitelist {
        default 0;
        1.1.1.0/24 1;  # cdn的ip访问白名单
    }

    # 请求超过阈值，断开连接
    limit_req_status 444;
    # 限制单个ip的请求数，避免单个ip打爆服务，请根据实际业务进行修改
    limit_req_zone $limit_key   zone=req_ip:10m   rate=5r/s;
    # 限制单个服务的请求数，避免请求过载打爆服务，请根据实际业务进行修改
    limit_req_zone $server_name zone=req_svr:1m   rate=1000r/s;
    # 限制单个uri的请求数，避免带宽被打爆，请根据实际业务进行修改
    limit_req_zone $uri         zone=req_res:10m  rate=3r/s;
    
    # 基于User-Agent的限流
    limit_req_zone $bad_ua zone=bad_ua:5m rate=1r/m;
    
    # 基于时间的限流
    limit_req_zone $time_window zone=time_win:10m rate=100r/s;

    # 连接数超过阈值，断开连接
    limit_conn_status 444;
    # 限制单个ip的连接数
    limit_conn_zone $limit_key zone=con_ip:10m;

    # 限速的共享内存，如果不够可以改大
    lua_shared_dict traffic_stats 50m;
    # 引入lua模块
    lua_package_path "/app/?.lua;;";
    
    # 初始化worker时设置定时保存
    init_worker_by_lua_block {
        local persistence = require "persistence"
        persistence.setup_timer_save()
    }

    server {
        # 设置dns解析
        resolver 8.8.8.8 ipv6=off;
        # 监听80和443端口
        listen 80;
        listen 443 ssl;
        # 关闭文件索引，避免文件结构泄漏
        autoindex off;
        # 设置静态文件的目录
        root /www;
        # 开启OCSP装订，加速TLS握手效率
        ssl_stapling on;
        ssl_stapling_verify on;
        # 配置ssl证书和密钥
        ssl_certificate /app/cert.crt;
        ssl_certificate_key /app/cert.key;
        # SSL会话有效期
        ssl_session_timeout 5m;
        # 使用SSL版本，加密算法
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
        ssl_prefer_server_ciphers on;
        # 开启HSTS，强制用户浏览器使用https协议
        # add_header Strict-Transport-Security "max-age=2592000";

        # 开启gzip压缩，配置压缩文件类型，压缩等级，最小压缩长度，关闭IE浏览器压缩
        gzip on;
        gzip_types *;
        gzip_comp_level 6;
        gzip_min_length 256;
        gzip_buffers 16 8k;
        gzip_proxied any;
        gzip_vary on;
        gzip_disable "MSIE [1-6]\.(?!.*SV1)";

        # 配置匹配的域名 (重要，必须修改)
        server_name www.dk8s.com hwy.520613.xyz;

        # 限制下行带宽
        limit_rate 100k;
        limit_rate_after 1m;

        # 限制连接数
        limit_conn con_ip 40;

        # 检查客户浏览器端是否断开连接
        lua_check_client_abort on;

        # 引入限速配置文件
        include /app/env.conf;

        # 开启CDN源IP访问白名单
        # deny all;
        # allow $whitelist;

        # ==================== 高级安全检测 ====================
        # 恶意User-Agent阻止
        if ($bad_ua) {
            return 444;
        }

        # 恶意请求头阻止
        if ($bad_header) {
            return 444;
        }

        # 异常快速请求检测和CDN流量处理
        set $extra_limits "";
        
        # 异常快速请求检测
        if ($fast_request) {
            set $extra_limits "${extra_limits}time_win,";
        }

        # CDN流量特殊处理
        if ($cdn_whitelist) {
            set $extra_limits "${extra_limits}cdn,";
        }

        # --- 添加以下两行来记录请求开始时间 ---
        access_by_lua_block {
            ngx.ctx.start_clock = os.clock()
        }
        # ---------------------------------------

        # 如果后段服务为http服务，请保留这一段，并修改后段服务地址
        location / {

            # 对单个ip进行限速，请根据实际业务进行修改
            limit_req zone=req_ip burst=100 delay=200;
            # 对整个服务进行限速，请根据实际业务进行修改
            limit_req zone=req_svr burst=1000 delay=2000;
            # 向后端传递host名
            proxy_set_header Host $host;
            # 对请求IP进行限速处理
            access_by_lua_file /app/protect.lua;
            # # 对请求IP流量进行统计
            # log_by_lua_file /app/record.lua;
            # 调试使用
            # lua_code_cache off;
            # access_by_lua_file /app/protect.lua;
            # log_by_lua_file /app/record.lua;
            # 如果是纯静态网站，请保留index，并删除proxy_pass。
            # index index.php index.html index.htm;
            # 后段服务地址，请 根据实际情况修改
            proxy_pass http://127.0.0.1:3000;

            # 对请求IP流量进行统计 一定要放在最后 否则统计不准确
            log_by_lua_file /app/record.lua;
        }

        # 后段服务为php-fpm。请保留这一段，否则删除
        # location / {
        #     # 对单个ip进行限速，请根据实际业务进行修改
        #     limit_req zone=req_ip burst=100 delay=200;
        #     # 对整个服务进行限速，请根据实际业务进行修改
        #     limit_req zone=req_svr burst=1000 delay=2000;
        #     # 向后端传递host名
        #     proxy_set_header Host $host;
        #     # 对请求IP进行限速处理
        #     access_by_lua_file /app/protect.lua;
        #     # 对请求IP流量进行统计
        #     log_by_lua_file /app/record.lua;
        #     # 调试使用
        #     # lua_code_cache off;
        #     # access_by_lua_file /app/protect.lua;
        #     # log_by_lua_file /app/record.lua;
        #     # 逐个匹配php、html、htm
        #     index index.php index.html index.htm;
        # }

        # 后段服务为php-fpm。请保留这一段，否则删除
        # location ~ \.php$ {
        #     # 对单个ip进行限速，请根据实际业务进行修改
        #     limit_req zone=req_ip burst=100 delay=200;
        #     # 对整个服务进行限速，请根据实际业务进行修改
        #     limit_req zone=req_svr burst=1000 delay=2000;
        #     # 向后端传递host名
        #     proxy_set_header Host $host;
        #     # 对请求IP进行限速处理
        #     access_by_lua_file /app/protect.lua;
        #     # 对请求IP流量进行统计
        #     log_by_lua_file /app/record.lua;
        #     # 调试使用
        #     # lua_code_cache off;
        #     # access_by_lua_file /app/protect.lua;
        #     # log_by_lua_file /app/record.lua;
        #     # php-fpm的地址，请 根据实际情况修改
        #     fastcgi_pass   127.0.0.1:9000;
        #     fastcgi_index  index.php;
        #     fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
        #     include        fastcgi_params;
        # }

        # 查看ip的统计信息
        location /dk8s.stats {
            # 对单个ip进行限速 burst突发请求数允许最多 100 个请求超过速率限制进入队列 delay立即处理而不延迟的请求数量超过就排队
            limit_req zone=req_ip burst=100 delay=200;
            # 对整个服务进行限速 
            limit_req zone=req_svr burst=1000 delay=2000;
            # lua_code_cache off;
            # access_by_lua_file /app/protect.lua;
            # log_by_lua_file /app/record.lua;
            access_by_lua_file /app/protect.lua;
            content_by_lua_file /app/stats.lua;
            log_by_lua_file /app/record.lua;
        }

        # 手动保存/加载数据接口
        location /dk8s.save {
            # 对单个ip进行限速
            limit_req zone=req_ip burst=1 delay=1;
            # 对整个服务进行限速
            limit_req zone=req_svr burst=1 delay=1;

            access_by_lua_file /app/protect.lua;

            content_by_lua_file /app/save_data.lua;

            log_by_lua_file /app/record.lua;
        }

        # 查看JSON数据接口
        location /dk8s.view {
            # 对单个ip进行限速
            limit_req zone=req_ip burst=10 delay=20;
            # 对整个服务进行限速
            limit_req zone=req_svr burst=100 delay=200;

            access_by_lua_file /app/protect.lua;

            content_by_lua_file /app/view_data.lua;

            log_by_lua_file /app/record.lua;
        }

        # 图片资源等信息，用作配置浏览器缓存。请修改后段服务地址，或删除proxy_pass，并把图片存到/www/所在位置
        location ~* \.(jpg|png|jpeg)$ {
            # 对单个ip进行限速
            limit_req zone=req_ip burst=100 delay=200;
            # 对整个服务进行限速
            limit_req zone=req_svr burst=1000 delay=2000;
            # 对uri进行限速，防止刷单个资源，导致带宽被打爆
            limit_req zone=req_res burst=200 delay=1000;
            # lua_code_cache off;
            # access_by_lua_file /app/protect.lua;
            # log_by_lua_file /app/record.lua;
            # 设置浏览器资源过期时间
            expires 7d;
            proxy_set_header Host $host;
            access_by_lua_file /app/protect.lua;
            # log_by_lua_file /app/record.lua;
            # 后段服务地址，请 根据实际情况修改。如果资源存在/www/所在的位置，请删除proxy_pass
            proxy_pass http://127.0.0.1:3000;

            # 对请求IP流量进行统计 一定要放在最后 否则统计不准确
            log_by_lua_file /app/record.lua;
        }

        # 样式资源等信息，用作配置浏览器缓存。请修改后段服务地址，或删除proxy_pass，并把js，css存到/www/所在位置
        location ~* \.(js|css|svg|woff|woff2)$ {
            # 对单个ip进行限速
            limit_req zone=req_ip burst=100 delay=200;
            # 对整个服务进行限速
            limit_req zone=req_svr burst=1000 delay=2000;
            # 对uri进行限速，防止刷单个资源，导致带宽被打爆
            limit_req zone=req_res burst=200 delay=1000;
            # lua_code_cache off;
            # access_by_lua_file /app/protect.lua;
            # log_by_lua_file /app/record.lua;
            # 设置浏览器资源过期时间
            expires 1d;
            # 向后端传递host名
            proxy_set_header Host $host;
            # 让浏览器每次请求检查资源是否过期
            add_header Cache-Control no-cache;
            access_by_lua_file /app/protect.lua;
            # log_by_lua_file /app/record.lua;
            # 后段服务地址，请 根据实际情况修改。如果资源存在/www/所在的位置，请删除proxy_pass
            proxy_pass http://127.0.0.1:3000;

            # 对请求IP流量进行统计 一定要放在最后 否则统计不准确
            log_by_lua_file /app/record.lua;
        }

        error_page 429 @429;
        location @429 {
            return 429 "error";
        }

        # location /control_group {
        #     # 测速的对照组，生产环境请删除
        #     proxy_set_header Host $host;
        #     proxy_pass http://127.0.0.1:3000;
        #     access_by_lua_block {
        #         ngx.exit(429)
        #     }
        #     log_by_lua_block {
        #         local a=0;
        #     }
        # }
    }

    # Cloudflare SaaS 支持 - 允许通过CDN接入的未知域名
    server {
        listen 80 default_server;
        listen 443 ssl default_server;
        
        # 设置默认行为 - 拒绝所有访问
        ssl_reject_handshake on;
        
        # 只有Cloudflare CDN IP才能访问
        location / {
            # 非CDN流量直接拒绝
            if ($is_cloudflare = 0) {
                return 444;
            }
            
            # Cloudflare SaaS流量，转发到后端
            proxy_pass http://127.0.0.1:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 对CDN流量应用宽松限制
            limit_req zone=req_ip burst=200 delay=400;
            limit_req zone=req_svr burst=2000 delay=4000;
            limit_conn con_ip 80;
            
            access_by_lua_file /app/protect.lua;
            log_by_lua_file /app/record.lua;
        }
    }

    server {
        # 测试用
        listen 3000;
        location / {
            return 200 'Ok';
        }
    }
}
